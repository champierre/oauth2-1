# OAuth 2.1 ãƒ•ãƒ­ãƒ¼å›³è§£èª¬

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€OAuth 2.1ã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’è¦–è¦šçš„ã«è§£èª¬ã—ã¾ã™ã€‚

## OAuth 2.1 èªè¨¼ãƒ•ãƒ­ãƒ¼å…¨ä½“å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ãƒ¦ãƒ¼ã‚¶ãƒ¼      â”‚    â”‚ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ     â”‚    â”‚ èªå¯ã‚µãƒ¼ãƒãƒ¼    â”‚
â”‚   (ãƒ–ãƒ©ã‚¦ã‚¶)    â”‚    â”‚ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ â”‚    â”‚ (Auth Server)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚                        â”‚
         â”‚                        â”‚                        â”‚
    1. ã‚¢ã‚¯ã‚»ã‚¹                   â”‚                        â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
         â”‚                        â”‚                        â”‚
         â”‚                   2. PKCEç”Ÿæˆ                   â”‚
         â”‚                    code_verifier                â”‚
         â”‚                    code_challenge               â”‚
         â”‚                        â”‚                        â”‚
         â”‚  3. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ      â”‚                        â”‚
         â”‚    +code_challenge      â”‚                        â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
         â”‚                        â”‚                        â”‚
         â”‚              4. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€               â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                        â”‚                        â”‚
         â”‚              5. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ»èªå¯ç”»é¢          â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                        â”‚                        â”‚
    6. èªå¯è¨±å¯                   â”‚                        â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                        â”‚                        â”‚
         â”‚      7. èªå¯ã‚³ãƒ¼ãƒ‰ + state                     â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                        â”‚                        â”‚
         â”‚   8. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯       â”‚                        â”‚
         â”‚    +èªå¯ã‚³ãƒ¼ãƒ‰          â”‚                        â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
         â”‚                        â”‚                        â”‚
         â”‚                        â”‚  9. ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆâ”‚
         â”‚                        â”‚     +code_verifier      â”‚
         â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                        â”‚                        â”‚
         â”‚                        â”‚ 10. PKCEæ¤œè¨¼ + ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œâ”‚
         â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                        â”‚                        â”‚
         â”‚  11. æˆåŠŸç”»é¢è¡¨ç¤º       â”‚                        â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
         â”‚                        â”‚                        â”‚
```

## ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°è§£èª¬

### ğŸ”„ Step 1-2: OAuth ãƒ•ãƒ­ãƒ¼é–‹å§‹ã¨PKCEç”Ÿæˆ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼                     ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
   â”‚                            â”‚
   â”‚ 1. "OAuthèªè¨¼é–‹å§‹"ã‚¯ãƒªãƒƒã‚¯  â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                            â”‚ 2. PKCE ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”Ÿæˆ
   â”‚                            â”‚    code_verifier = random(32bytes)
   â”‚                            â”‚    code_challenge = SHA256(code_verifier)
   â”‚                            â”‚
```

**ã“ã“ã§é‡è¦ãªã®ã¯ï¼š**
- `code_verifier`: 43-128æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—
- `code_challenge`: code_verifierã®SHA256ãƒãƒƒã‚·ãƒ¥ã‚’Base64URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
- ã“ã®2ã¤ãŒPKCE (Proof Key for Code Exchange) ã®æ ¸å¿ƒ

### ğŸ” Step 3-4: èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼                     ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                 èªå¯ã‚µãƒ¼ãƒãƒ¼
   â”‚                            â”‚                            â”‚
   â”‚ 3. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæŒ‡ç¤º        â”‚                            â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
   â”‚                            â”‚                            â”‚
   â”‚ 4. èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹                         â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                            â”‚                            â”‚
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼š**
```
GET /authorize?
  response_type=code&
  client_id=demo-client&
  redirect_uri=http://localhost:3000/callback&
  scope=read&
  state=abc123xyz&
  code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&
  code_challenge_method=S256
```

### âœ… Step 5-6: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨èªå¯

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼                                              èªå¯ã‚µãƒ¼ãƒãƒ¼
   â”‚                                                      â”‚
   â”‚ 5. èªå¯ç”»é¢è¡¨ç¤º                                      â”‚
   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
   â”‚    â”‚ OAuth 2.1 Authorization     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚    â”‚                             â”‚                  â”‚
   â”‚    â”‚ Client: Demo App            â”‚                  â”‚
   â”‚    â”‚ Scope: read                 â”‚                  â”‚
   â”‚    â”‚                             â”‚                  â”‚
   â”‚    â”‚ [Approve] [Deny]            â”‚                  â”‚
   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
   â”‚                                                      â”‚
   â”‚ 6. "Approve" ã‚¯ãƒªãƒƒã‚¯                               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                                      â”‚
```

### ğŸ” Step 7-8: èªå¯ã‚³ãƒ¼ãƒ‰ç™ºè¡Œã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼                     ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                 èªå¯ã‚µãƒ¼ãƒãƒ¼
   â”‚                            â”‚                            â”‚
   â”‚ 7. èªå¯ã‚³ãƒ¼ãƒ‰ä»˜ããƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                            â”‚                            â”‚
   â”‚ 8. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URL ã‚¢ã‚¯ã‚»ã‚¹ â”‚                            â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
   â”‚                            â”‚                            â”‚
```

**ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLä¾‹ï¼š**
```
http://localhost:3000/callback?
  code=SplxlOBeZQQYbYS6WxSbIA&
  state=abc123xyz
```

### ğŸ”‘ Step 9-10: ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ› (æœ€é‡è¦)

```
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                                               èªå¯ã‚µãƒ¼ãƒãƒ¼
     â”‚                                                          â”‚
     â”‚ 9. ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆ                               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                                          â”‚
     â”‚                                            10. PKCEæ¤œè¨¼  â”‚
     â”‚                                               â”‚          â”‚
     â”‚                                               â–¼          â”‚
     â”‚                                    received_challenge =  â”‚
     â”‚                                    SHA256(code_verifier) â”‚
     â”‚                                               â”‚          â”‚
     â”‚                                               â–¼          â”‚
     â”‚                                    original_challenge == â”‚
     â”‚                                    received_challenge?   â”‚
     â”‚                                               â”‚          â”‚
     â”‚                                               â–¼ YES      â”‚
     â”‚                                       ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œâ”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                                          â”‚
```

**ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼š**
```
POST /token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=SplxlOBeZQQYbYS6WxSbIA&
redirect_uri=http://localhost:3000/callback&
client_id=demo-client&
client_secret=demo-secret&
code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼š**
```json
{
  "access_token": "2YotnFZFEjr1zCsicMWpAA",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "read"
}
```

## ğŸ›¡ï¸ OAuth 2.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹å¾´

### PKCE (Proof Key for Code Exchange)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PKCE ã®ä»•çµ„ã¿                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. code_verifier ç”Ÿæˆ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)                   â”‚
â”‚     â”œâ”€ ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ— (43-128æ–‡å­—)                      â”‚
â”‚     â””â”€ ä¾‹: "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk" â”‚
â”‚                                                         â”‚
â”‚  2. code_challenge ç”Ÿæˆ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)                  â”‚
â”‚     â”œâ”€ SHA256(code_verifier)                            â”‚
â”‚     â””â”€ Base64URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰                             â”‚
â”‚                                                         â”‚
â”‚  3. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚                                    â”‚
â”‚     â””â”€ code_challenge ã‚’é€ä¿¡                            â”‚
â”‚                                                         â”‚
â”‚  4. ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›æ™‚                                      â”‚
â”‚     â”œâ”€ code_verifier ã‚’é€ä¿¡                             â”‚
â”‚     â””â”€ ã‚µãƒ¼ãƒãƒ¼ãŒSHA256ã§æ¤œè¨¼                           â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹CSRFé˜²æ­¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  State ã®å½¹å‰²                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. ãƒ©ãƒ³ãƒ€ãƒ ãªstateå€¤ç”Ÿæˆ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)                â”‚
â”‚     â””â”€ ä¾‹: "abc123xyz789"                               â”‚
â”‚                                                         â”‚
â”‚  2. èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«stateè¿½åŠ                            â”‚
â”‚     â””â”€ GET /authorize?...&state=abc123xyz789            â”‚
â”‚                                                         â”‚
â”‚  3. èªå¯ã‚µãƒ¼ãƒãƒ¼ãŒstateã‚’ãã®ã¾ã¾è¿”ã™                   â”‚
â”‚     â””â”€ /callback?code=...&state=abc123xyz789            â”‚
â”‚                                                         â”‚
â”‚  4. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒstateå€¤ã‚’æ¤œè¨¼                         â”‚
â”‚     â”œâ”€ é€ä¿¡ã—ãŸå€¤ã¨ä¸€è‡´ï¼Ÿ â†’ OK                          â”‚
â”‚     â””â”€ ä¸€è‡´ã—ãªã„ â†’ CSRFæ”»æ’ƒã®å¯èƒ½æ€§                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š OAuth 2.0 vs OAuth 2.1 æ¯”è¼ƒ

| é …ç›® | OAuth 2.0 | OAuth 2.1 |
|------|-----------|-----------|
| **PKCE** | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | **å¿…é ˆ** |
| **Implicit Grant** | åˆ©ç”¨å¯èƒ½ | **å»ƒæ­¢** |
| **Password Grant** | åˆ©ç”¨å¯èƒ½ | **å»ƒæ­¢** |
| **Bearer Token Usage** | RFC 6750 | **RFC 6750 + ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–** |
| **Redirect URI** | éƒ¨åˆ†ä¸€è‡´OK | **å®Œå…¨ä¸€è‡´å¿…é ˆ** |
| **State Parameter** | æ¨å¥¨ | **å¼·ãæ¨å¥¨** |

## ğŸ” å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

### 1. PKCEå®Ÿè£…

```javascript
// âœ… æ­£ã—ã„PKCEå®Ÿè£…
function generatePKCE() {
  const codeVerifier = base64url(crypto.randomBytes(32));
  const codeChallenge = base64url(sha256(codeVerifier));
  return { codeVerifier, codeChallenge };
}
```

### 2. ã‚»ã‚­ãƒ¥ã‚¢ãªStateç”Ÿæˆ

```javascript
// âœ… æ­£ã—ã„Stateå®Ÿè£…
function generateState() {
  return base64url(crypto.randomBytes(32));
}
```

### 3. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼

```javascript
// âœ… æ­£ã—ã„PKCEæ¤œè¨¼
function verifyPKCE(codeVerifier, storedChallenge) {
  const computedChallenge = base64url(sha256(codeVerifier));
  return computedChallenge === storedChallenge;
}
```

## âš ï¸ ã‚ˆãã‚ã‚‹å®Ÿè£…ãƒŸã‚¹

### âŒ é–“é•ã£ãŸPKCEå®Ÿè£…

```javascript
// âŒ å›ºå®šå€¤ã‚’ä½¿ç”¨ (å±é™º)
const codeVerifier = "fixed-string";

// âŒ çŸ­ã™ãã‚‹ãƒ©ãƒ³ãƒ€ãƒ å€¤
const codeVerifier = base64url(crypto.randomBytes(8)); // 8bytesã¯çŸ­ã™ã

// âŒ MD5ã‚’ä½¿ç”¨ (SHA256ãŒå¿…é ˆ)
const codeChallenge = md5(codeVerifier);
```

### âŒ Stateæ¤œè¨¼ã®æ¼ã‚Œ

```javascript
// âŒ Stateæ¤œè¨¼ãªã—
app.get('/callback', (req, res) => {
  const { code } = req.query;
  // stateã®æ¤œè¨¼ã‚’ã—ã¦ã„ãªã„ï¼
  exchangeCodeForToken(code);
});
```

## ğŸ¯ ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã®å®Ÿè£…ç¢ºèªæ–¹æ³•

1. **ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã‚’é–‹ã**
2. **OAuth ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹**
3. **å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç¢ºèªï¼š**
   - èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: `code_challenge`, `state`
   - ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›: `code_verifier`
   - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `access_token`

## ğŸ“š å‚è€ƒè³‡æ–™

- [OAuth 2.1 Specification (Draft)](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1)
- [RFC 7636: PKCE](https://tools.ietf.org/html/rfc7636)
- [OAuth 2.0 Security Best Current Practice](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics)